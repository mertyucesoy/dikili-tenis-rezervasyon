{% extends 'court/base.html' %}

{% block content %}
<div class="d-flex justify-content-center align-items-start">
  <div class="card shadow p-4" style="min-width: 350px; max-width: 600px; width: 100%;">
    <h2 class="text-center mb-4">Rezervasyon Yap</h2>

    <!-- Tarih seçimi (takvimli) -->
    <form method="get" class="mb-4">
      <div class="mb-3">
        <label for="datepicker" class="form-label">Tarih Seçin</label>
        <input id="datepicker"
               type="text"
               name="date"
               class="form-control text-center"
               value="{{ selected_date }}"
               readonly>
      </div>
    </form>

    <!-- Saat seçimi -->
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="date" value="{{ selected_date }}">

      <div class="mb-3">
        <label for="time_slot" class="form-label">Saat Aralığı</label>
        <select name="time_slot" class="form-select text-center" required>
          {% for slot in all_slots %}
            {% if slot in reserved_slots %}
              <option value="{{ slot }}" disabled style="color: gray;">{{ slot }} (Dolu)</option>
            {% else %}
              <option value="{{ slot }}">{{ slot }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>

      {% if user_locked %}
        <div class="alert alert-warning text-center">
          Mevcut başka bir rezervasyonunuz olduğu için yeni bir rezervasyon yapamazsınız.
        </div>
      {% endif %}

      <button type="submit" class="btn btn-success w-100" {% if user_locked %}disabled{% endif %}>
        Rezervasyon Yap
      </button>
    </form>
  </div>
</div>

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    flatpickr("#datepicker", {
      dateFormat: "Y-m-d",              // sistem formatı
      altInput: true,
      altFormat: "d F Y",               // kullanıcıya görünen format
      defaultDate: "{{ selected_date }}",
      minDate: "{{ today }}",           // bugün
      maxDate: "{{ max_date }}",        // 2 gün sonrası
      locale: "tr",
      disable: [
        function(date) {
          // saat 00:00'dan önceki tarihleri devre dışı bırak
          const today = new Date();
          today.setHours(0,0,0,0);
          return date < today;
        }
      ],
      onChange: function(selectedDates, dateStr, instance) {
        instance.element.form.submit();
      }
    });
  });
</script>

{% endblock %}
